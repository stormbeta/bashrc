#!/usr/bin/env bash

# Helper script to hardwire k8s cluster api IPs to /etc/hosts as a buffer against DNS issues

# IMPORTANT - add the following block to your /etc/hosts first!
# === KUBERNETES HOSTS ===
# === END ===

function kube-hosts {
  for apiserver in $(kubectl config view -ojson | jq '.clusters[].cluster.server | sub("^https://";"")' -r | uniq); do
    echo "# K8S Cluster: ${apiserver}"
    for ip in $(dig +short "$apiserver"); do
      echo "${ip} ${apiserver}"
    done
  done
}

sudo cp /etc/hosts /tmp/hosts.backup

if grep -q '# === KUBERNETES HOSTS ===' /etc/hosts; then
  gsed -e "/# === KUBERNETES HOSTS ===/,/# === END ===/c\\\# === KUBERNETES HOSTS ===\n$(kube-hosts | perl -pe 's/\n/\\n/g')\# === END ===" /etc/hosts > /tmp/hosts
  sudo cp /tmp/hosts /etc/hosts
fi
